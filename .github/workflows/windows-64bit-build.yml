name: Windows 64-bit Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 支持手动触发构建

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 CMake
        uses: lukka/get-cmake@latest

      - name: 安装 Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17,)'  # 适配 Visual Studio 2022 及以上版本

      - name: 安装依赖（OpenSSL、gperf、iconv）
        run: |
          choco install openssl --version=3.1.1
          choco install gperf
          # 安装 iconv
          $iconvUrl = "https://github.com/win-iconv/win-iconv/releases/download/v0.0.8/win-iconv-0.0.8.zip"
          Invoke-WebRequest -Uri $iconvUrl -OutFile win_iconv.zip
          Expand-Archive win_iconv.zip -DestinationPath .
          mv win-iconv-0.0.8 iconv
          mkdir iconv-build
          cd iconv-build
          cmake -G "NMake Makefiles" -DBUILD_STATIC=ON -DBUILD_SHARED=OFF -DBUILD_EXECUTABLE=OFF -DBUILD_TEST=ON -DCMAKE_BUILD_TYPE=Release ..\iconv
          nmake
          cd ..
          mkdir -p build/lib
          cp iconv/iconv.h .
          cp iconv-build/iconv.lib ./build/lib

      - name: 创建并进入构建目录
        run: mkdir build && cd build

      - name: 配置 CMake
        run: |
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_MSDBLIB=ON \
            -DWITH_OPENSSL=ON \
            -DICONV_LIBRARY=../build/lib/iconv.lib \
            -DICONV_INCLUDE_DIR=..

      - name: 编译 FreeTDS
        run: |
          cd build
          msbuild ALL_BUILD.vcxproj /p:Configuration=Release /p:Platform=x64

      - name: 打包输出
        run: |
          cd build
          mkdir freetds-win64
          cp -r bin/Release/* freetds-win64/
          cp -r lib/Release/* freetds-win64/
          cp -r include/* freetds-win64/include/
          7z a freetds-win64.zip freetds-win64

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
         name: freetds-win64
         path: build/freetds-win64.zip
